# Sunnyday

Bluesky utility toolkit built with Vue 3 + TypeScript.

## Current v1 scope

- Login with Bluesky handle + app password
- Convert existing list to starter pack
- Convert starter pack to list (new or existing) by searching a user and choosing one of their starter packs
- Curated feed workspace with multiple feed profiles (create/rename/delete)
- Optional feed description and icon image per feed
- Per-feed automation config (words or regex, with case-sensitivity)
- Per-feed curated posts selected from search (add/remove)
- Draft vs published workflow with `Publish` and `Discard changes`
- Light/dark/system theme toggle

## Stack

- Vite
- Vue 3 + TypeScript
- Pinia
- Vue Router
- Tailwind CSS
- `@atproto/api`

## Run

```bash
npm install
npm run dev
```

## Publish Setup

1. **Sunnyday `.env`** — set the feed generator DID and (optional) URL + secret so the app can push feed contents when you click Publish:

   ```bash
   VITE_BSKY_FEEDGEN_DID=did:web:feeds.moke.me
   VITE_FEEDGEN_URL=https://feeds.moke.me
   VITE_FEEDGEN_SECRET=your-shared-secret
   ```

   If `VITE_FEEDGEN_URL` and `VITE_FEEDGEN_SECRET` are unset, Publish only updates the feed record on Bluesky; the feed will not load in the app until you run the feed generator and push contents (e.g. re-publish after the feedgen is running).

2. **Feed generator backend** — this repo includes a minimal feedgen in `feedgen/`. Run it on the same host/port your Nginx proxies to (e.g. 5000):

   ```bash
   cd feedgen
   cp .env.example .env
   # Edit .env: set FEEDGEN_DID and FEEDGEN_SECRET (same value as VITE_FEEDGEN_SECRET)
   npm install
   npm start
   ```

   Keep it running (e.g. with systemd or a process manager). When you Publish a feed from Sunnyday, the app sends the feed URI and post list to the feedgen; when users open the feed in Bluesky, the feedgen returns that list via `getFeedSkeleton`.

### Nginx + DID bootstrap script

Generate Nginx config (including `/xrpc/` and `/internal/` proxy), DID document, and env snippet:

```bash
scripts/setup-feed-domain.sh \
  --domain feeds.moke.me \
  --backend http://127.0.0.1:5000
```

It will create:
- `deploy/nginx/feeds.moke.me.conf`
- `deploy/nginx/feeds.moke.me.http-only.conf`
- `deploy/did/.well-known/did.json`
- `deploy/.env.feedgen`

## Notes

- Session tokens are persisted in browser `localStorage` for persistent login.
- App password is used only on login and not intentionally persisted.
- `Publish` now creates/updates a Bluesky `app.bsky.feed.generator` record.
- Deleting a published feed attempts to delete its `app.bsky.feed.generator` record on Bluesky first.
- For feed delivery and discoverability, your feed-generator service/DID must be properly deployed and resolvable.

## Troubleshooting: “Some kind of issue occurred when contacting the feed server”

That message is shown **by the Bluesky app** when it cannot reach your feed generator or gets an invalid response. Sunnyday only publishes the feed record; Bluesky then calls the URL from your DID to load the feed. Fix the following on the **feed generator server** (the backend that serves the feed), not in Sunnyday:

1. **Feed generator backend must be running**  
   This repo includes a minimal feedgen in `feedgen/`. Run `npm start` there (see Publish Setup). It implements `describeFeedGenerator` and `getFeedSkeleton`; Sunnyday pushes feed contents to it when you click Publish. If you use a different backend, it must implement the [ATProto feed generator API](https://atproto.com/specs/feed-generator).

2. **DID resolution**  
   For `did:web:feeds.yourdomain.com`, Bluesky fetches `https://feeds.yourdomain.com/.well-known/did.json`. That URL must be publicly reachable over HTTPS and return a valid DID document with a `BskyFeedGenerator` service endpoint (as generated by `setup-feed-domain.sh`).

3. **Service URL**  
   The DID document’s `serviceEndpoint` (e.g. `https://feeds.yourdomain.com`) must be the same origin (or correctly routed) so that Bluesky’s requests to `/xrpc/app.bsky.feed.getFeedSkeleton` hit your backend. Nginx (or your reverse proxy) must proxy `/xrpc/` to the process that implements the feed generator.

4. **TLS and DNS**  
   Use valid HTTPS and DNS for the feed domain. Bluesky will not call an HTTP or unreachable host.

5. **Backend health**  
   If the backend crashes, returns 5xx, or returns a body that doesn’t match the feed skeleton schema, Bluesky will show the same error. Check your feed generator logs when you open the feed in the app.

### “Could not resolve identity: did:web:feeds.moke.me”

This means the DID document is not reachable at **https://feeds.moke.me/.well-known/did.json**. Fix deployment first:

1. **DNS** – `feeds.moke.me` must point to your server (`A` or `AAAA` record). Check with:  
   `dig +short feeds.moke.me`
2. **TLS** – Get a certificate for `feeds.moke.me` (e.g. `certbot --nginx -d feeds.moke.me`). The Nginx config expects certs under `/etc/letsencrypt/live/feeds.moke.me/`.
3. **DID file** – Copy the generated DID document so Nginx can serve it:
   ```bash
   sudo mkdir -p /var/www/feeds/.well-known
   sudo cp deploy/did/.well-known/did.json /var/www/feeds/.well-known/did.json
   ```
4. **Nginx** – Install the server block and reload:
   ```bash
   sudo cp deploy/nginx/feeds.moke.me.conf /etc/nginx/sites-available/
   sudo ln -sf /etc/nginx/sites-available/feeds.moke.me.conf /etc/nginx/sites-enabled/
   sudo nginx -t && sudo systemctl reload nginx
   ```
5. **Verify** – From any machine (or [web](https://feeds.moke.me/.well-known/did.json)):
   ```bash
   curl -sS https://feeds.moke.me/.well-known/did.json
   ```
   You should see JSON with `"id":"did:web:feeds.moke.me"` and a `BskyFeedGenerator` service. Until this URL returns that document over HTTPS, Bluesky will keep reporting “could not resolve identity”.

### “Message from server: UpstreamFailure”

This means Bluesky reached your domain (DID resolved and the request hit your server), but the **upstream** failed. Nginx proxies `/xrpc/` to the backend URL you configured (e.g. `http://127.0.0.1:5000`). “UpstreamFailure” usually means:

1. **Nothing is listening on the backend port**  
   The feed generator service is not running. Nginx tries to proxy to e.g. port 5000 and gets “connection refused”.  
   Check: `ss -tlnp | grep 5000` or `curl -sS -o /dev/null -w "%{http_code}" http://127.0.0.1:5000/xrpc/app.bsky.feed.getFeedSkeleton` (may be 404/400 but confirms something is answering).

2. **The process on that port is not a feed generator**  
   The app must implement the [ATProto feed generator](https://github.com/bluesky-social/feed-generator) contract: at least `app.bsky.feed.getFeedSkeleton` (and usually `app.bsky.feed.describeFeedGenerator`). If it’s a different service or a stub that returns 5xx or invalid JSON, Bluesky will show UpstreamFailure.

3. **The backend crashed or timed out**  
   Check the feed generator’s logs when you open the feed in the Bluesky app.

**This repo includes a minimal feed generator in `feedgen/`.** Run it with `cd feedgen && npm install && npm start`, set `FEEDGEN_DID` and `FEEDGEN_SECRET` in `feedgen/.env`, and set `VITE_FEEDGEN_URL` and `VITE_FEEDGEN_SECRET` in the Sunnyday `.env` so Publish pushes feed contents. Run that backend on the port your Nginx config proxies to (e.g. 5000), then try the feed again.
